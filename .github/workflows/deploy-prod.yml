name: Deploy to Production

on:
  push:
    branches:
      - "main"

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        uses: salesforcecli/action-setup@v2
        with:
          install: "sf"

      - name: Authenticate Prod Org
        run: |
          echo "$PROD_SFDX_AUTH_URL" > sfdx_auth_url.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth_url.txt --alias ProdOrg --set-default
        env:
          PROD_SFDX_AUTH_URL: ${{ secrets.PROD_SFDX_AUTH_URL }}

      - name: Deploy to Production
        run: |
          sf project deploy start --source-dir force-app --target-org ProdOrg --test-level RunLocalTests --wait 60

      - name: Run Apex Tests (optional explicit)
        run: |
          sf apex run test --target-org ProdOrg --result-format human --wait 60